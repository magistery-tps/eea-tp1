---
title: |
    | Maestría en Explotación de datos y Descubrimiento de conocimiento
    |
    |
    | Materia: Analisis Estadistico del Aprendizaje
    | Trabajo práctico 1: Regresion Lineal
author: "Adrian Norberto Marino"
date: "2021/09/19"
fig_width: 3 
fig_height: 3 
output:
  html_document: 
    highlight: pygments
    theme: sandstone
    includes:
      before_body: ./header.html
      after_body: ./footer.html
---

```{r}
options(warn=-2)
# install.packages("pacman")
library(pacman)
p_load(tidyverse, GGally, fastDummies, plotly)
p_load_gh('adrianmarino/commons')
import('../src/dataset.R')
import('../src/preprocessing.R')
```

```{r}
raw_train_set <- load_train_set()
raw_test_set  <- load_test_set()

train_set <- preprocess(raw_train_set)
test_set  <- preprocess(raw_test_set)
```

## 1. Análisis exploratorios

Leer el archivo "encuesta_salud_train.csv". ¿Qué puede mencionar sobre su estructura y variables? ¿Cómo es la correlación entre las variables numéricas? Utilice y analice en detalle algún gráfico que sirva para sacar conclusiones sobre la asociación de variables realizando apertura por género. En particular, ¿cómo es la correlación entre la variable a explicar (peso) y el resto de las variables numéricas? Para las categorías de la variable frecuencia de hambre mensual, analice gráficamente la distribución en términos de frecuencia relativa de:

a)  El consumo semanal de verdura.
b)  El consumo semanal de comida grasa.

¿Cuáles son las principales características que observa en estos gráficos?

# 1.1 ¿Qué puede mencionar sobre su estructura y variables?

```{r}
glimpse(train_set)
```

```{r}
hist_plots <- function(df, columns=c()) {
  if(is_empty(columns)) {
    columns <- df %>% dplyr::select(is.numeric) %>% colnames()
  }
  for(col in columns) {
    p <- ggplot(df, aes(!!sym(col))) + 
      geom_histogram(col="red", aes(fill=..count..), alpha = .65) +
      scale_fill_gradient("Frecuencia", low="green", high="red")
    print(p)
  }
}

box_plots <- function(df) {
  df %>% 
    pivot_longer(is.numeric, names_to = "Variables", values_to = "Frecuencia") %>%
    ggplot(aes(x = Variables, y = Frecuencia, fill = Variables)) +
    scale_y_continuous(limits = c(0, 180)) +
    geom_boxplot(width=0.7) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
}

missings_summary <- function(
  df, 
  missings = c(NA, NULL, 'Dato perdido')
) {
  df %>% 
      gather(., key = Variable, value = value) %>%
      mutate(is_missing = if_else(value %in% missings, 1, 0)) %>%
      group_by(Variable) %>% 
      summarise(
        `Nª Categorias` = n_distinct(value),
        `Nª Faltantes`   = sum(is_missing),
        `% Faltantes`    = round(`Nª Faltantes` / nrow(df) * 100, 2)
      ) %>%
      arrange(desc(`% Faltantes`), `Nª Categorias`)
}

important_variables_set <- function(result, top=3, metrics=c("%IncMSE", "IncNodePurity")) {
  metrics %>% 
    map(function(metric) top_acc_features(result, top, metric) ) %>% 
    unlist() %>% 
    unique()
}

bar_plots <- function(
  df, 
  columns    = c(),
  width      = 0.9, 
  count_size = 2
) {
  if(is_empty(columns)) {
    columns <- train_set %>% dplyr::select(!is.numeric) %>% colnames()
  }
  for(column in columns) {
    p <- ggplot(
      df %>% 
         group_by(!!sym(column)) %>% 
         tally() %>%
         mutate(Frecuencia = n), 
      aes(x=!!sym(column), y=Frecuencia, fill=!!sym(column))
    ) +
    geom_col(stat="identity", width=width, position = "dodge") +
    geom_text(aes(label=Frecuencia), vjust=2, color="white", size=count_size) +
    theme_minimal() +
    theme(
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()
    )
    print(p)
  }
}

mapping_cols = c(
  "consumo_semanal_comida_grasa",
  "consumo_semanal_verdura",
  "consumo_semanal_snacks",
  "consumo_semanal_gaseosas",
  "consumo_semanal_frutas",
  "nivel_educativo",
  "edad_consumo_alcohol"
)

show_values <- function(df , columns=c()) {
  if(is_empty(columns)) {
    columns <- df %>% colnames()
  }
  for(column in columns) {
    p <- df %>% group_by(!!sym(column)) %>% tally()
    print(p)
  }
}

drop_missings <- function(df, special_missings = c('Dato perdido')) {
  df <- df %>% drop_na()
  column_names <- df %>% colnames()

  for(col in  column_names) {
    for(missing in special_missings) {
      df <-df %>% filter(!grepl(missing, !!sym(col)))
    }
  }
  df
}
```

```{r}
mapping <- load_df_from_csv('../dataset/mapping.csv')

table <- train_set %>% 
  left_join(mapping, by = c("nivel_educativo" = "source")) %>% 
  mutate(nivel_educativo = target) %>% 
  select(-target)

table <- table %>% 
  left_join(mapping, by = c("consumo_semanal_frutas" = "source")) %>% 
  mutate(consumo_semanal_frutas = target) %>% 
  select(-target)

table <- table %>% 
  left_join(mapping, by = c("consumo_semanal_comida_grasa" = "source")) %>% 
  mutate(consumo_semanal_comida_grasa = target) %>% 
  select(-target)

table <- table %>% 
  left_join(mapping, by = c("consumo_semanal_snacks" = "source")) %>% 
  mutate(consumo_semanal_snacks = target) %>% 
  select(-target)

table <- table %>% 
  left_join(mapping, by = c("consumo_semanal_verdura" = "source")) %>% 
  mutate(consumo_semanal_verdura = target)  %>% 
  select(-target)

table <- table %>%
  left_join(mapping, by = c("consumo_semanal_gaseosas" = "source")) %>% 
  mutate(consumo_semanal_gaseosas = target) %>% 
  select(-target)

table <- table %>%
  left_join(mapping, by = c("edad_consumo_alcohol" = "source")) %>% 
  mutate(edad_consumo_alcohol = target) %>% 
  select(-target)
```

```{r}
show_values(train_set)
```

```{r}
show_values(table, mapping_cols)
```

```{r}
train_set <- table
train_set <- drop_missings(train_set)
missings_summary(train_set)
```

```{r}
missings_summary(train_set)
```

```{r}
train_set <- train_set %>% drop_na()
missings_summary(train_set)
```

```{r}
hist_plots(train_set)
```

```{r}
box_plots(train_set)
```

```{r}
bar_plots(train_set)
```

```{r}
fi_result <- features_importance(train_set, target_column)
plot_features_importance(fi_result)
```

```{r}
most_important_variables <- important_variables_set(fi_result)
most_important_variables
```

```{r}
train_set %>%
  dplyr::select(c(most_important_variables, genero)) %>% 
  ggpairs(
    aes(color=genero), 
    upper = list(continuous = wrap("cor", size = 3, hjust=0.8, alignPercent=0.15)), 
    legend = 25
  ) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, vjust=0.5), legend.position = "bottom")
```

```{r}
one_hot_encode <- function(df) {
  cat_variables <- cat_vars(train_set)
  dummy_cols(df,  select_columns = cat_variables) %>% 
    dplyr::select(-cat_variables)
}

encoded_train_set <- one_hot_encode(train_set)
encoded_test_set <- one_hot_encode(test_set)
encoded_test_set
```

## 2. Modelo inicial

Se plantea que una primera alternativa para modelar el peso es:

E(peso) = β0+β1altura+β2edad+β3genero+β4diasActividadFisicaSemanal+β5consumoDiarioAlcohol

¿Cuál es la interpretación de cada uno de los coeficientes estimados? ¿Son significativos? ¿El modelo resulta significativo para explicar el peso? ¿Qué porcentaje de la variabilidad explica el modelo?

## 3. Modelo categóricas

Se sugiere probar un modelo que incopore el consumo semanal de snacks y una interacción entre el género y la edad, en lugar de actividad física y consumo de alcohol:

E(peso) = β0 + β1altura + β2edad + β3genero + β4consumoSemanalSnacks + β5genero · edad

Además se pide explícitamente que la categoría "No comí comida salada o snacks en los últimos 7 días" de la variable consumoSemanalSnacks se encuentre como nivel/categoría basal. ¿Cuál es la interpretación de los coeficientes estimados para las categorías de consumoSemanalSnacks y genero . edad? ¿Son significativas? ¿Qué porcentaje de la variabilidad explica el modelo? En caso de detectar que existen categorías no significativas de la variable consumoSemanalSnacks evaluar si la variable es significativa en su conjunto y, en caso afirmativo, proponer una redefinición de las mismas que permita obtener una mayor proporción de categorías significativas individualmente. Luego, analizar si existen cambios en la variabilidad explicada por el modelo.

## 4. Modelos propios y evaluación

Realizar 2 modelos lineales múltiples adicionales y explicar brevemente la lógica detrás de los mismos (se valorará la creación y/o inclusión de variables nuevas). Evaluar la performance del modelo inicial, el modelo categóricas con las categorías redefinidas de la variable consumoSemanalSnacks y los modelos desarrollados en este punto en el dataset de entrenamiento y evaluación (usar dataset "encuesta_salud_test.csv"). La evaluación de performance consiste en comparar en ambos sets la performance en términos del R cuadrado ajustado, RMSE y MAE.

¿Cuál es el mejor modelo para nuestro objetivo de predecir el peso? ¿Por qué?

## 5. Diagnóstico del modelo

Analizar en profundidad el cumplimiento de los supuestos del modelo lineal para el modelo inicial.

## 6. Modelo Robusto

Leer el archivo "encuesta_salud_modelo6.csv". Este último consiste en el dataset original de train con la incorporación de algunas observaciones adicionales que pueden incluir valores atípicos. En particular, observar la relación entre peso y altura ¿Qué ocurre con estos nuevos datos? Entrenar el modelo inicial con estos nuevos datos y comentar qué se observa en los coeficientes estimados y las métricas de evaluación (R cuadrado ajustado, RMSE y MAE) respecto al modelo entrenado con el set de entrenamiento original. Entrenar un modelo robusto con la misma especificación que el modelo inicial sobre los nuevos datos. Comparar los coeficientes y su performance (RMSE y MAE) respecto al modelo inicial no robusto entrenado en este punto. ¿Qué puede concluir al respecto?
